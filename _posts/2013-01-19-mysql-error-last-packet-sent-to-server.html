---
layout: post
title: 'MySQL error: last packet sent to the server was XXX ms ago'
date: '2013-01-19T22:26:00.001-08:00'
author: Yevgeniy Brikman
tags:
- HowTo
- Software Engineering
modified_time: '2013-01-20T12:14:34.727-08:00'
blogger_id: tag:blogger.com,1999:blog-5422014336627804072.post-5423786048310633287
blogger_orig_url: http://brikis98.blogspot.com/2013/01/mysql-error-last-packet-sent-to-server.html
---

I just spent a few weeks battling a strange, infrequent, hard-to-reproduce error when using JDBC to talk to MySQL. After about a dozen experiments, I think I've finally found a solution and I've decided to capture the details here, since my online searches didn't turn up this particular answer anywhere else.<br /><br /><b>tldr</b>: If you see a "last packet sent to the server was XXX ms ago" error, you may want to upgrade your version of the mysql-connector-java library.<br /><br /><span style="font-size: x-large;"><b>The Symptoms</b></span><br /><br />I had a simple Java app in production that was using JDBC to talk to a MySQL DB. Everything was running great: DB calls were taking 2 ms on average and 8 ms in the 99th percentile. However, once every 4-8 hours, a strange error would pop up that looked something like this: <br /><br /><script src="https://gist.github.com/4576833.js"></script> <br />I can understand the occasionally slow query, but 28800126 ms? EOFException? What's going on here?<br /><br /><span style="font-size: x-large;"><b>Lots of ineffective options</b></span><br /><br />As usual, I turned to a programmer's two best friends: Google and StackOverflow. I quickly found my way to the&nbsp;<a href="http://dev.mysql.com/doc/refman/5.6/en/connector-j-usagenotes-troubleshooting.html#qandaitem-22-3-15-1-12">MySQL docs</a>&nbsp;and found out that MySQL has two timeout settings that will close a connection if it is idle for too long: <a href="http://dev.mysql.com/doc/refman/5.0/en/server-system-variables.html#sysvar_interactive_timeout">interactive_timeout</a> and <a href="http://dev.mysql.com/doc/refman/5.0/en/server-system-variables.html#sysvar_wait_timeout">wait_timeout</a>. The default value for these two settings is 28800000 ms or 8 hours.<br /><br />The general advice online was to make sure that your connection management library was sending periodic "keep-alive" queries to prevent connections from going idle. I was using&nbsp;<a href="https://github.com/wwadge/bonecp">BoneCP</a>, so I tried everything I could to make it behave properly, including a few&nbsp;<a href="http://stackoverflow.com/questions/11945833/java-bonecp-mysql-connection-timing-out">configuration tweaks</a>&nbsp;as well as workarounds for a <a href="https://bugs.launchpad.net/bonecp/+bug/999114">connection leak bug</a> and a <a href="http://jolbox.com/forum/viewtopic.php?f=3&amp;t=387">releaseHelperThreads bug</a>.&nbsp;Nothing worked.<br /><br />Eventually, I swapped out BoneCP entirely for a different connection management library. Nevertheless, after a few hours, the dreaded "last packet sent to the server was XXX ms ago" error would pop up on the production box.<br /><br /><b><span style="font-size: x-large;">The solution at last</span></b><br /><br />For a while, I was at a loss. I couldn't see how two entirely different DB connection management libraries could have the same bug. I began digging for what the two had in common and realized that, under the hood, both would be using the same JDBC driver. For MySQL, this is <a href="http://dev.mysql.com/downloads/connector/j/">Connector/J</a>.<br /><br />It's at this point that I noticed that I was, for some reason, using Connector/J version 3.1.12, which is quite old. In fact, it is officially&nbsp;<a href="http://dev.mysql.com/doc/refman/5.0/en/connector-j-versions.html">obsolete</a>&nbsp;and only compatible with MySQL 5.0 and below. This is unfortunate, as I was using MySQL 5.5 in production.<br /><br />I figured it was a long shot that this was the cause of the errors I was seeing, but I figured that using the "recommended" connector version was a good idea anyway. I updated from mysql-connector-java version 3.1.12 to version 5.1.22.<br /><br />And just like that, all the errors were gone.<br /><br /><b><span style="font-size: x-large;">The final word</span></b><br /><br />So, there you have it. &nbsp;If you see a "last packet sent to the server was XXX ms ago", it's likely one of two things:<br /><ol><li>Your DB connection management library is leaving idle connections open too long</li><li>You're hitting an incompatibility bug between the Connector/J version and the MySQL DB version</li></ol><br /><ul></ul>