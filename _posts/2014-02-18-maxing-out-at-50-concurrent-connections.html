---
layout: post
title: Maxing out at 50 concurrent connections with Play or Netty on OS X? Here's
  a fix.
date: '2014-02-18T18:07:00.000-08:00'
author: Yevgeniy Brikman
tags:
- HowTo
- Software Engineering
modified_time: '2014-02-18T18:09:23.869-08:00'
blogger_id: tag:blogger.com,1999:blog-5422014336627804072.post-2521038555779866353
blogger_orig_url: http://brikis98.blogspot.com/2014/02/maxing-out-at-50-concurrent-connections.html
---

I recently ran across a strange problem with the <a href="http://www.playframework.com/">Play Framework</a> and <a href="http://netty.io/">Netty</a>: on Linux, my Play app could easily handle thousands of concurrent connections; on OS X, the same app maxed out at around 50 concurrent connections. It took a while to figure out the problem, so in this post, I'm documenting the solution in case other folks run into the same issue in the future. Note: if you're using raw Netty, the fix is very straightforward; if you're using Play, it's much trickier, and I hope it will be fixed in Play itself in the near future.<br /><br /><b>tldr</b>: set the backlog option on Netty's Bootstrap object to a higher value (<a href="http://stackoverflow.com/a/8455894/483528">example</a>).<br /><br /><b><span style="font-size: x-large;">Symptoms</span></b><br /><br />On OS X, your Play or Netty app cannot handle more than ~50 concurrent connections. A simple way to test this is to use <a href="http://httpd.apache.org/docs/2.2/programs/ab.html">Apache Bench</a>:<br /><br /><script src="https://gist.github.com/brikis98/9083297.js"></script><br />As soon as you set the concurrency level (the -c parameter) above 50, you'll get the error "apr_socket_recv: Connection reset by peer (54)". Moreover, your Play or Netty app will never actually see the request and nothing will show up in the logs.<br /><br />However, if you run the same experiment against the same app running on Linux, even with the concurrency level set to several hundred or several thousand, all requests will complete successfully, without errors. Therefore, there must be something OS specific causing this problem.<br /><br />To be fair, it's rare to use OS X in any production or high traffic capacity - for example, at LinkedIn, we use OS X in dev, but Linux in prod - so the concurrency limitation is rarely a problem. However, we had a few use cases where, even in dev mode, we had to make many concurrent calls to the same app, so we had to find a solution.<br /><br /><b><span style="font-size: x-large;">The Cause</span></b><br /><br />It turns out that "50" is the default&nbsp;size for the "backlog" parameter in Java's <a href="http://grepcode.com/file/repository.grepcode.com/java/root/jdk/openjdk/6-b27/java/net/ServerSocket.java#199">ServerSocket</a>. It is even explained in the <a href="http://docs.oracle.com/javase/7/docs/api/java/net/ServerSocket.html#ServerSocket(int)">JavaDoc</a>:<br /><blockquote class="tr_bq">The maximum queue length for incoming connection indications (a request to connect) is set to 50. If a connection indication arrives when the queue is full, the connection is refused.</blockquote>Therefore, whatever code manages sockets in Netty must use different configurations for the backlog parameter on Linux and OS X. This code is likely&nbsp;tied to the selector implementation for the OS: I'm guessing the Linux version uses epoll, while OS X uses kqueue. The former probably sets backlog to some reasonable value (perhaps from OS settings) while the latter just uses the default (which is 50).<br /><br /><b><span style="font-size: x-large;">The Solution (pure Netty)</span></b><br /><br />After some more digging, this <a href="http://stackoverflow.com/questions/8442166/how-to-allow-more-concurrent-client-connections-with-netty">StackOverflow thread</a> reveals that the Netty <a href="http://netty.io/4.0/api/io/netty/bootstrap/ServerBootstrap.html">ServerBootstrap</a> class lets you set an option to override the backlog:<br /><br /><script src="https://gist.github.com/brikis98/9083511.js"></script> If you're using pure netty, just use the code above and the 50 concurrent connections limit will vanish immediately!  <br /><br />Also worth noting: this issue exists in Netty 3.x, but apparently Netty 4.x sets a better default than 50 on all OS's, so upgrading Netty versions may be another solution.<br /><br /><b><span style="font-size: x-large;">The Solution (Play)</span></b><br /><br />Play instantiates the ServerBootstrap class inside of&nbsp;<a href="https://github.com/playframework/playframework/blob/eb9a3e8f919c36a41f5cdbc553a0590317983c34/framework/src/play/src/main/scala/play/core/server/NettyServer.scala">NettyServer.scala</a>. Unfortunately,&nbsp;neither the class nor the boostrap instance inside of it are accessible to app code. This should be easy to fix via a pull request, but until that happens, and until a new version is available, here is a two part workaround to get moving.<br /><br /><b>Note</b>: this is an <i>ugly</i> hack with lots of copy/paste from the original Play source code and is only meant as a temporary workaround. It has been tested with <a href="https://github.com/playframework/playframework/releases/tag/2.2.1">Play 2.2.1</a>; figure out which version of Play you're on and be sure to use code from that <a href="https://github.com/playframework/playframework/releases">release</a>!<br /><br /><b>Step 1: make a local copy of NettyServer.scala called TempNettyServer.scala</b><br /><br />You'll want to put TempNettyServer.scala in a different SBT project than your normal app code - that is, don't just put it in the app folder. &nbsp;See&nbsp;<a href="http://www.scala-sbt.org/release/docs/Getting-Started/Multi-Project">SBT Multi-Project Builds</a>&nbsp;for more info.<br /><br />The folder structure looks something like this: my-app is my original Play app and monkey-patch is a new SBT project for TempNettyServer.scala:<br /><br /><script src="https://gist.github.com/brikis98/9084215.js"></script> Copy the contents of the original <a href="https://github.com/playframework/playframework/blob/eb9a3e8f919c36a41f5cdbc553a0590317983c34/framework/src/play/src/main/scala/play/core/server/NettyServer.scala">NettyServer.scala</a> into TempNettyServer.scala, with two changes:<br /><ol><li>Replace all NettyServer references to TempNettyServer</li><li>In the newBootstrap method, make the change below to allow configuring the backlog option</li></ol><br /><script src="https://gist.github.com/brikis98/9084271.js"></script> Now, configure this new SBT project in project/Build.scala: <br /><br /><script src="https://gist.github.com/brikis98/9084325.js"></script> <br /><b>Step 2: override the run and start commands to use TempNettyServer</b><br /><b><br /></b>Ready for more copy/paste?<br /><br />Grab <a href="https://github.com/playframework/playframework/blob/eb9a3e8f919c36a41f5cdbc553a0590317983c34/framework/src/sbt-plugin/src/main/scala/PlayRun.scala">PlayRun.scala</a> and copy it into the project folder under some other name, such as TempPlayRun.scala and make two changes:<br /><ol><li>Replace all PlayRun references with TempPlayRun: there should only be one, which is the class name.</li><li>Replace all NettyServer references with TempNettyServer: there should two, both in String literals, used in the "run" and "start" commands to fire up the app.</li></ol>Now, update the settings in project/Build.scala to use your versions of the "run" and "start" commands:<br /><br /><script src="https://gist.github.com/brikis98/9084454.js"></script> <br /><b><span style="font-size: x-large;">A note on OS limits</span></b><br /><br />After making the changes above, you should be able to handle more than 50 concurrent connections. However, depending on how your OS is configured, you might still hit a limit at 128 or so. This is probably due to the kernel config&nbsp;<a href="http://www5.us.freebsd.org/doc/handbook/configtuning-kernel-limits.html#idp75584176">kern.ipc.somaxconn</a>, which controls "the size of the listen queue for accepting new TCP connections" and has a default of 128.<br /><br />To tweak this limit, you can run the following command:<br /><br /><script src="https://gist.github.com/brikis98/9084493.js"></script> Your Netty or Play app should now be able to handle over 1000 concurrent connections (or more, depending on what limits you set above). <br /><br />